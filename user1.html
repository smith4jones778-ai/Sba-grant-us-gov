<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Real-time Chat (Agent / Applicant)</title>
  <style>
    :root{
      --primary:#1976d2; --light:#e8f0fe; --bg:#f4f6fb; --text:#222;
      --muted:#6b7280; --radius:10px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto;
      background:var(--bg); color:var(--text);
    }
    .wrap{max-width:820px;margin:24px auto;padding:20px;background:#fff;border-radius:12px;
      box-shadow:0 6px 30px rgba(20,30,60,.08); min-height:80vh; display:flex; flex-direction:column;}
    .top{display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #eee;padding-bottom:14px}
    h1{font-size:1.15rem;margin:0}
    .controls{display:flex;gap:8px}
    button{background:var(--primary);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
    button.ghost{background:#fff;color:var(--primary);border:1px solid var(--primary)}
    .meta{font-size:0.9rem;color:var(--muted); margin-top:10px}
    .chat-area{flex:1;margin-top:16px;padding:16px;border-radius:10px;border:1px solid #eee;background:#fbfdff; overflow:auto}
    .msg{display:flex;flex-direction:column;max-width:78%;margin-bottom:12px}
    .msg .who{font-weight:600;font-size:0.85rem;margin-bottom:6px}
    .bubble{padding:10px 12px;border-radius:10px;white-space:pre-wrap; word-break:break-word}
    .agent{align-self:flex-start}
    .agent .bubble{background:var(--light); color:var(--text)}
    .user{align-self:flex-end;text-align:right}
    .user .bubble{background:#e8eaf0;color:var(--text)}
    .time{font-size:0.78rem;color:var(--muted);margin-top:6px}
    .input-row{display:flex;gap:10px;margin-top:12px}
    input[type="text"]{flex:1;padding:12px;border-radius:10px;border:1px solid #ddd;font-size:1rem}
    .small{font-size:0.85rem;color:var(--muted)}
    .status{margin-top:8px;font-size:0.9rem;color:var(--muted)}
    @media (max-width:640px){
      .wrap{margin:6px}
      .controls{flex-wrap:wrap}
    }
  </style>
</head>
<body>
  <div class="wrap" role="main">
    <div class="top">
      <div>
        <h1 id="title">Chat</h1>
        <div class="meta" id="meta">Initializing...</div>
      </div>
      <div class="controls">
        <button id="openEmail">Email</button>
        <button id="copyRoom" class="ghost">Copy room link</button>
      </div>
    </div>

    <div id="chatArea" class="chat-area" aria-live="polite"></div>

    <div class="input-row">
      <input id="messageInput" type="text" placeholder="Type message and press Enter or Send" autocomplete="off" />
      <button id="sendBtn">Send</button>
    </div>

    <div class="status" id="status">Not connected yet.</div>
  </div>

  <!-- Firebase compat SDKs (works with the initializeApp style used here) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    /*********** CONFIG - replace with your own Firebase project if required ***********/
    const firebaseConfig = {
      apiKey: "AIzaSyBK5UM0n8-GLvleW7l6B8Hi-_WuC64QA4U",
      authDomain: "scores-b25a7.firebaseapp.com",
      databaseURL: "https://scores-b25a7-default-rtdb.firebaseio.com",
      projectId: "scores-b25a7",
      storageBucket: "scores-b25a7.appspot.com",
      messagingSenderId: "1001957936318",
      appId: "1:1001957936318:web:90fdfb367f82f6a3d8e2ef"
    };
    // Initialize
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    /**********************************************************************************/

    // Helpers
    const qs = new URLSearchParams(location.search);
    let role = qs.get('role');
    if (!role || (role !== 'agent' && role !== 'user')) {
      // If not set, allow a default toggle behavior: try to detect 'agent' if url contains 'agent'
      role = (location.search.indexOf('agent') >= 0) ? 'agent' : 'user';
    }
    // Room ID (use provided or a stable default); you can also generate one like room_ + uuid
    const room = qs.get('room') || 'room_default_1';

    const emailTarget = 'smith4jones778@gmail.com';

    // DOM
    const titleEl = document.getElementById('title');
    const metaEl = document.getElementById('meta');
    const chatArea = document.getElementById('chatArea');
    const statusEl = document.getElementById('status');
    const inputEl = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const openEmailBtn = document.getElementById('openEmail');
    const copyRoomBtn = document.getElementById('copyRoom');

    // UI init
    titleEl.textContent = `Chat — ${role === 'agent' ? 'Agent' : 'Applicant'}`;
    metaEl.textContent = `Room: ${room} • Role: ${role}`;

    openEmailBtn.addEventListener('click', () => {
      // mailto as requested
      window.location.href = `mailto:${encodeURIComponent(emailTarget)}?subject=${encodeURIComponent('Regarding Application')}`;
    });

    copyRoomBtn.addEventListener('click', async () => {
      const url = location.origin + location.pathname + `?role=${role}&room=${room}`;
      try {
        await navigator.clipboard.writeText(url);
        copyRoomBtn.textContent = 'Link copied!';
        setTimeout(()=> copyRoomBtn.textContent = 'Copy room link', 1800);
      } catch(e){
        alert('Copy failed. Here is the room URL:\n' + url);
      }
    });

    sendBtn.addEventListener('click', sendMessage);
    inputEl.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });

    // Sanitize text to avoid injection (we'll set textContent so it's OK, but keep helper)
    function esc(s){ return String(s || ''); }

    // Render a message in the chat area
    function renderMessage(msg){
      const container = document.createElement('div');
      container.className = 'msg ' + (msg.sender === 'agent' ? 'agent' : 'user');

      const who = document.createElement('div');
      who.className = 'who';
      who.textContent = (msg.sender === role) ? 'You' : (msg.sender === 'agent' ? 'Agent' : 'Applicant');

      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.textContent = msg.text || '';

      const time = document.createElement('div');
      time.className = 'time';
      const d = new Date(msg.timestamp || Date.now());
      time.textContent = d.toLocaleString();

      container.appendChild(who);
      container.appendChild(bubble);
      container.appendChild(time);

      chatArea.appendChild(container);
      // keep latest in view
      chatArea.scrollTop = chatArea.scrollHeight;
    }

    // Send to Firebase
    function sendMessage(){
      const text = inputEl.value.trim();
      if (!text) return;
      const msg = { sender: role, text: text, timestamp: Date.now() };
      statusEl.textContent = 'Sending...';
      // Push to room path
      db.ref('chats/' + room).push(msg)
        .then(() => {
          inputEl.value = '';
          statusEl.textContent = 'Sent';
          setTimeout(()=> statusEl.textContent = 'Connected', 900);
        })
        .catch(err => {
          console.error(err);
          statusEl.textContent = 'Send failed: ' + err.message;
        });
    }

    // Listen for messages from Firebase
    let messagesListenerAttached = false;
    function listenMessages(){
      const ref = db.ref('chats/' + room);
      // prevent duplicate listeners if function called more than once
      if (messagesListenerAttached) {
        ref.off();
      }
      // initial load: optional — if you want to clear and re-load, you can use once('value')
      ref.on('child_added', snap => {
        const msg = snap.val();
        // msg should contain sender, text, timestamp
        if (!msg) return;
        renderMessage(msg);
      }, err => {
        console.error('listener error', err);
        statusEl.textContent = 'Listener error: ' + (err && err.message ? err.message : err);
      });

      messagesListenerAttached = true;
    }

    // Anonymous Auth then start listeners
    auth.signInAnonymously()
      .then(() => {
        statusEl.textContent = 'Connected (anonymous).';
        // show connection state from realtime database
        const connectedRef = db.ref(".info/connected");
        connectedRef.on("value", snap => {
          const val = snap.val();
          statusEl.textContent = val ? 'Connected' : 'Offline';
        });

        // Start listening for messages for this room
        listenMessages();
      })
      .catch(err => {
        console.error('auth error', err);
        statusEl.textContent = 'Auth error: ' + (err && err.message ? err.message : err);
      });

    // For convenience, allow pressing Ctrl+Enter to send also
    inputEl.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') sendMessage();
    });

    // Optional: show an initial instruction if no messages after a moment
    setTimeout(() => {
      if (chatArea.children.length === 0) {
        const hint = { sender: 'system', text: 'No messages yet. Say hi!', timestamp: Date.now() };
        // but show it as muted system bubble
        const sys = document.createElement('div');
        sys.className = 'msg agent';
        const who = document.createElement('div'); who.className='who'; who.textContent = 'System';
        const bubble = document.createElement('div'); bubble.className='bubble'; bubble.textContent = 'No messages yet. Say hi!';
        bubble.style.background = '#fff7e6';
        bubble.style.color = '#6b4a00';
        sys.appendChild(who); sys.appendChild(bubble);
        chatArea.appendChild(sys);
      }
    }, 900);

    // Accessibility: focus input on load
    window.addEventListener('load', () => {
      inputEl.focus();
    });

  </script>
</body>
  </html>
