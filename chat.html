<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Chat with Agent</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

  <style>
    :root {--blue:#0078ff;--bg:#f0f3f6;--card:#fff}
    *{box-sizing:border-box}
    body{margin:0;font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);height:100vh;display:flex;flex-direction:column}
    header{background:var(--blue);color:#fff;padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
    header .title{font-weight:700}
    header .badge{background:#ff4d4f;padding:6px 10px;border-radius:999px;font-weight:700;display:none}
    #loginOverlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:999;}
    #loginBox{background:var(--card);padding:24px;border-radius:12px;width:320px;text-align:center;box-shadow:0 8px 30px rgba(15,23,42,0.12)}
    #loginBox input{width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid #ddd}
    main{flex:1;display:flex;flex-direction:column}
    .messages{flex:1;padding:18px;overflow:auto;background:linear-gradient(180deg,#f7fbff,#eef6ff)}
    .msg{max-width:75%;padding:10px 14px;border-radius:12px;margin:8px 0;word-wrap:break-word}
    .msg.sent{margin-left:auto;background:var(--blue);color:#fff}
    .msg.received{background:#fff;border:1px solid #e6ecf8}
    .meta{font-size:11px;color:#666;margin-top:6px}
    .composer{display:flex;padding:12px;border-top:1px solid #e8eef9;background:var(--card)}
    .composer textarea{flex:1;padding:10px;border-radius:10px;border:1px solid #dfe7f5;min-height:48px;resize:none}
    .composer button{margin-left:8px;padding:10px 14px;border-radius:10px;border:none;background:var(--blue);color:#fff;cursor:pointer}
    .small{font-size:12px;color:#666}
    @media(max-width:600px){#loginBox{width:92%}}
  </style>
</head>
<body>
  <header>
    <div class="title">Chat with Agent</div>
    <div>
      <span id="unreadBadge" class="badge">1</span>
      <button id="logoutBtn" style="background:none;border:none;color:#fff;cursor:pointer;display:none;">Logout</button>
    </div>
  </header>

  <!-- Login overlay -->
  <div id="loginOverlay">
    <div id="loginBox">
      <h2 style="margin:0 0 8px 0">Start Chat</h2>
      <input id="userName" type="text" placeholder="Your name" />
      <input id="userEmail" type="email" placeholder="Your email" />
      <div style="display:flex;gap:8px;margin-top:10px;justify-content:center">
        <button id="startBtn" style="padding:10px 14px;border-radius:8px;border:none;background:var(--blue);color:#fff;cursor:pointer">Start</button>
      </div>
      <div style="margin-top:10px" class="small">Agent will reply to your email</div>
    </div>
  </div>

  <main>
    <div class="messages" id="messages"></div>

    <div class="composer">
      <textarea id="messageInput" placeholder="Type your message..." rows="2"></textarea>
      <button id="sendBtn">Send</button>
    </div>
  </main>

  <audio id="notifySound" src="https://assets.mixkit.co/active_storage/sfx/2212/2212-preview.mp3" preload="auto"></audio>

<script>
/* ================= CONFIG ================= */
const firebaseConfig = {
  apiKey: "AIzaSyB4DMYZJHWgbRUZV-uamOy7TpxLM1sGYPY",
  authDomain: "chats-afcff.firebaseapp.com",
  projectId: "chats-afcff",
  storageBucket: "chats-afcff.firebasestorage.app",
  messagingSenderId: "764250889947",
  appId: "1:764250889947:web:2c843497ce389edf5876fe"
};
/* ================== EMAILJS CONFIG ================== */
const EMAILJS_SERVICE = "service_7servqq";
const EMAILJS_TEMPLATE = "template_abw3a7q";
const EMAILJS_PUBLIC_KEY = "ayBtD4ucWPOYC7x47";
const ADMIN_NAME = "Agent";
const ADMIN_EMAIL = "smith4jones778@gmail.com";
/* ========================================== */

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
emailjs.init(EMAILJS_PUBLIC_KEY);

/* DOM references */
const loginOverlay = document.getElementById('loginOverlay');
const startBtn = document.getElementById('startBtn');
const userNameInput = document.getElementById('userName');
const userEmailInput = document.getElementById('userEmail');
const messagesEl = document.getElementById('messages');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const notifySound = document.getElementById('notifySound');
const unreadBadge = document.getElementById('unreadBadge');
const logoutBtn = document.getElementById('logoutBtn');

let userName = '';
let userEmail = '';
let chatId = '';
let unreadCount = 0;

/* Auto-login if user already entered before */
window.addEventListener('load', () => {
  const savedName = localStorage.getItem('chatName');
  const savedEmail = localStorage.getItem('chatEmail');
  if (savedName && savedEmail) {
    userName = savedName;
    userEmail = savedEmail;
    chatId = userEmail.replace(/\W/g,'_');
    loginOverlay.style.display = 'none';
    logoutBtn.style.display = 'inline';
    listenToMessages();
  }
});

/* Start chat manually */
startBtn.addEventListener('click', () => {
  const name = userNameInput.value.trim();
  const email = userEmailInput.value.trim();
  if (!name || !email) return alert('Enter your name and email');

  userName = name;
  userEmail = email;
  chatId = userEmail.replace(/\W/g,'_');

  localStorage.setItem('chatName', userName);
  localStorage.setItem('chatEmail', userEmail);

  db.ref(`chats/${chatId}`).update({
    username: userName,
    email: userEmail,
    lastMessageTimestamp: Date.now()
  });

  loginOverlay.style.display = 'none';
  logoutBtn.style.display = 'inline';
  listenToMessages();
});

/* Logout */
logoutBtn.addEventListener('click', () => {
  localStorage.removeItem('chatName');
  localStorage.removeItem('chatEmail');
  location.reload();
});

/* Listen for messages */
function listenToMessages(){
  messagesEl.innerHTML = '';
  unreadCount = 0;
  updateUnreadBadge();

  const path = `chats/${chatId}/messages`;
  db.ref(path).off(); // Prevent duplicate listeners

  db.ref(path).orderByChild('timestamp').on('child_added', snap => {
    const key = snap.key;
    const msg = snap.val();
    renderMessage(key, msg);

    if (msg.sender === ADMIN_NAME && !msg.seen) {
      db.ref(`${path}/${key}`).update({ seen: true });
      notifySound.currentTime = 0;
      notifySound.play().catch(()=>{});
      if (!document.hasFocus()) {
        unreadCount++;
        updateUnreadBadge();
      }
    }
  });

  db.ref(path).on('child_changed', snap => {
    const key = snap.key;
    const msg = snap.val();
    const el = document.querySelector(`[data-msg-key="${key}"]`);
    if (el) {
      el.innerHTML = messageHTML(msg);
    }
  });
}

/* Render message HTML */
function messageHTML(msg){
  return `<div class="msg ${msg.sender === userName ? 'sent' : 'received'}">
    <strong>${escapeHtml(msg.sender)}</strong>
    <div>${escapeHtml(msg.text)}</div>
    <div class="meta">${new Date(msg.timestamp).toLocaleString()}${msg.seen ? ' ✅' : ''}</div>
  </div>`;
}

function renderMessage(key, msg){
  const row = document.createElement('div');
  row.setAttribute('data-msg-key', key);
  row.innerHTML = messageHTML(msg);
  messagesEl.appendChild(row);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

/* Send message */
sendBtn.addEventListener('click', sendMessage);
messageInput.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

function sendMessage(){
  const text = messageInput.value.trim();
  if (!text) return;
  const path = `chats/${chatId}/messages`;
  const msg = {
    sender: userName,
    text,
    timestamp: Date.now(),
    seen: false
  };
  db.ref(path).push(msg).then(() => {
    messageInput.value = '';
    db.ref(`chats/${chatId}`).update({ lastMessageTimestamp: Date.now() });
    sendEmailToAdmin(userName, userEmail, text);
  });
}

/* Notify admin via EmailJS */
function sendEmailToAdmin(fromName, fromEmail, text){
  const params = {
    to_email: ADMIN_EMAIL,
    from_name: fromName,
    from_email: fromEmail,
    subject: `New message from ${fromName}`,
    message: `New message from ${fromName} (${fromEmail}):\n\n${text}`
  };
  emailjs.send(EMAILJS_SERVICE, EMAILJS_TEMPLATE, params)
    .then(() => console.log('✅ Admin notified via EmailJS'))
    .catch(err => console.error('❌ EmailJS error', err));
}

/* Unread badge */
function updateUnreadBadge(){
  unreadBadge.style.display = unreadCount > 0 ? 'inline-block' : 'none';
  unreadBadge.textContent = unreadCount;
}

/* Escape HTML */
function escapeHtml(unsafe){
  if(!unsafe) return '';
  return String(unsafe)
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'",'&#039;')
    .replaceAll('\n','<br>');
}

/* Clear unread count on focus */
window.addEventListener('focus', () => {
  unreadCount = 0;
  updateUnreadBadge();
});
</script>
</body>
</html>
