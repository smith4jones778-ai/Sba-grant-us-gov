<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Live Chat | Agent & Users</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

  <style>
    body {font-family: "Poppins", sans-serif; margin: 0; height: 100vh; display: flex; flex-direction: column; background: #f0f3f6;}
    header {background: #0078ff; color: white; padding: 12px; text-align: center; font-size: 20px; font-weight: 600;}
    .messages {flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; background: #eef3f8;}
    .msg {margin: 6px 0; padding: 10px 14px; border-radius: 16px; max-width: 70%; font-size: 15px;}
    .sent {background: #0078ff; color: white; align-self: flex-end;}
    .received {background: #e9ecef; align-self: flex-start;}
    .input-area {display: flex; padding: 10px; border-top: 1px solid #ddd; background: white;}
    textarea {flex: 1; padding: 10px; border-radius: 6px; border: 1px solid #ccc; resize: none; font-family: inherit;}
    button {margin-left: 8px; background: #0078ff; color: white; border: none; border-radius: 6px; padding: 10px 16px; cursor: pointer;}
    button:hover {background: #005fcc;}
    #loginForm {position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 9999;}
    #loginBox {background: white; padding: 30px; border-radius: 12px; width: 320px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.2);}
    #loginBox input {width: 90%; padding: 10px; margin: 8px 0; border-radius: 6px; border: 1px solid #ccc;}
  </style>
</head>
<body>

<header>üí¨ Chat with Agent Chen K</header>

<!-- Login Modal -->
<div id="loginForm">
  <div id="loginBox">
    <h2>Start Your Chat</h2>
    <input type="text" id="userName" placeholder="Your Name"><br>
    <input type="email" id="userEmail" placeholder="Your Email"><br>
    <button onclick="startChat()">Start Chat</button>
  </div>
</div>

<div class="messages" id="messages"></div>

<div class="input-area" id="inputArea" style="display:none;">
  <textarea id="messageInput" placeholder="Type your message..."></textarea>
  <button onclick="sendMessage()">Send</button>
</div>

<audio id="notifySound" src="https://assets.mixkit.co/active_storage/sfx/2212/2212-preview.mp3"></audio>

<script>
  // ==================== FIREBASE CONFIG ====================
  const firebaseConfig = {
    apiKey: "AIzaSyB4DMYZJHWgbRUZV-uamOy7TpxLM1sGYPY",
    authDomain: "chats-afcff.firebaseapp.com",
    databaseURL: "https://chats-afcff-default-rtdb.firebaseio.com",
    projectId: "chats-afcff",
    storageBucket: "chats-afcff.appspot.com",
    messagingSenderId: "764250889947",
    appId: "1:764250889947:web:2c843497ce389edf5876fe"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // ==================== EMAILJS CONFIG ====================
  const EMAILJS_SERVICE = "service_au8aho1";
  const EMAILJS_TEMPLATE = "template_7gfx3ty";
  const EMAILJS_PUBLIC_KEY = "NH7GD7-O8VKuKcfab";
  emailjs.init(EMAILJS_PUBLIC_KEY);

  const ADMIN_NAME = "Agent Chen K";
  const ADMIN_EMAIL = "smith4jones778@gmail.com";

  let userName = "";
  let userEmail = "";
  let chatId = "";

  // ==================== START CHAT ====================
  function startChat() {
    userName = document.getElementById("userName").value.trim();
    userEmail = document.getElementById("userEmail").value.trim();
    if (!userName || !userEmail) return alert("Please enter your name and email.");

    chatId = userEmail.replace(/\W/g, "_");
    document.getElementById("loginForm").style.display = "none";
    document.getElementById("inputArea").style.display = "flex";

    // Create or update chat record
    db.ref(`chats/${chatId}`).update({
      username: userName,
      email: userEmail
    });

    listenForMessages();
  }

  // ==================== LISTEN FOR MESSAGES ====================
  function listenForMessages() {
    const msgBox = document.getElementById("messages");
    msgBox.innerHTML = "";
    db.ref(`chats/${chatId}/messages`).on("child_added", snap => {
      const msg = snap.val();
      const div = document.createElement("div");
      div.classList.add("msg", msg.sender === userName ? "sent" : "received");
      div.innerHTML = `<b>${msg.sender}</b><br>${msg.text}`;
      msgBox.appendChild(div);
      msgBox.scrollTop = msgBox.scrollHeight;

      // Play notification if it's from admin
      if (msg.sender === ADMIN_NAME) {
        document.getElementById("notifySound").play();
      }
    });
  }

  // ==================== SEND MESSAGE ====================
  function sendMessage() {
    const input = document.getElementById("messageInput");
    const text = input.value.trim();
    if (!text) return;
    input.value = "";

    const msg = {
      sender: userName,
      text,
      timestamp: new Date().toISOString()
    };

    db.ref(`chats/${chatId}/messages`).push(msg);

    // Notify admin via Email
    sendEmailToAdmin(userName, userEmail, text);
  }

  // ==================== EMAILJS HELPERS ====================
  function sendEmailToAdmin(fromName, fromEmail, text) {
    const params = {
      to_email: ADMIN_EMAIL,
      from_name: fromName,
      from_email: fromEmail,
      subject: `New message from ${fromName}`,
      message: `New chat message from ${fromName} (${fromEmail}):\n\n${text}`
    };

    emailjs.send(EMAILJS_SERVICE, EMAILJS_TEMPLATE, params)
      .then(() => console.log("‚úÖ Admin notified by email"))
      .catch(err => console.error("‚ùå Admin email error:", err));
  }
</script>
</body>
</html>
