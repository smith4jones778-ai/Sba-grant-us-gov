<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin â€” Chat Dashboard (Enhanced)</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<!-- EmailJS -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

<!-- Fonts & Icons -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/boxicons@2.1.4/css/boxicons.min.css">

<style>
  :root{
    --bg:#f5f7fb;--panel:#ffffff;--muted:#6b7280;--accent:#0078ff;--danger:#ff4d4f;
    --glass: rgba(255,255,255,0.7);
  }
  [data-theme="dark"]{
    --bg:#0b1220;--panel:#071028;--muted:#a9b0bd;--accent:#2b9cff;--danger:#ff7474;--glass: rgba(10,14,20,0.6);
    color: #e6eef9;
  }

  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:"Poppins",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
  body{background:var(--bg);display:flex;flex-direction:column;min-height:100vh}

/* Top bar */
  .topbar{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--panel);box-shadow:0 1px 4px rgba(0,0,0,0.06)}
  .brand{display:flex;gap:12px;align-items:center}
  .brand .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#0061d9);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
  .brand h1{margin:0;font-size:16px}
  .controls{display:flex;gap:8px;align-items:center}

/* Layout */
  .app{display:flex;flex:1;min-height:calc(100vh - 64px);overflow:hidden}
  aside{width:320px;padding:14px;background:linear-gradient(180deg,var(--panel),var(--glass));border-right:1px solid rgba(0,0,0,0.04);display:flex;flex-direction:column;gap:12px}
  .search{display:flex;gap:8px}
  .search input{flex:1;padding:10px;border-radius:10px;border:1px solid #e6eef7;background:transparent;outline:none}
  .stats{display:flex;gap:8px}
  .stat{flex:1;background:linear-gradient(180deg,rgba(255,255,255,0.6),transparent);padding:10px;border-radius:10px;font-size:13px}
  #userList{overflow:auto;padding-right:6px;margin-top:6px}

/* user item */
  .userItem{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:transparent;cursor:pointer;transition:background .15s}
  .userItem:hover{background:rgba(0,0,0,0.03)}
  .uLeft{display:flex;gap:10px;align-items:center}
  .avatar{width:42px;height:42px;border-radius:10px;background:#e6eef7;color:#083b66;display:flex;align-items:center;justify-content:center;font-weight:700}
  .uname{font-weight:600}
  .uMeta{font-size:12px;color:var(--muted)}
  .uRight{display:flex;flex-direction:column;align-items:flex-end}
  .unread{background:var(--danger);color:#fff;padding:4px 8px;border-radius:999px;font-size:12px;min-width:28px;text-align:center}
  .smallBtn{background:transparent;border:1px solid rgba(0,0,0,0.06);padding:6px 8px;border-radius:8px;font-size:12px;cursor:pointer}

/* Chat area */
  .chatWrap{flex:1;display:flex;flex-direction:column;background:linear-gradient(180deg,transparent,rgba(0,0,0,0.02))}
  .chatHeader{display:flex;align-items:center;justify-content:space-between;padding:12px;border-bottom:1px solid rgba(0,0,0,0.04);background:var(--panel)}
  .chatHeader .title{display:flex;gap:12px;align-items:center}
  .metaRight{display:flex;gap:8px;align-items:center}
  .messages{flex:1;padding:16px;overflow:auto;display:flex;flex-direction:column;gap:8px;background:transparent}
  .bubble{max-width:78%;padding:10px 14px;border-radius:14px;font-size:15px;box-shadow:0 2px 6px rgba(11,22,40,0.04)}
  .bubble.self{align-self:flex-end;background:var(--accent);color:white;border-bottom-right-radius:6px}
  .bubble.other{align-self:flex-start;background:#eef3f8;color:#0b1b2b;border-bottom-left-radius:6px}
  .bmeta{font-size:11px;color:var(--muted);margin-top:6px}

/* composer */
  .composer{display:flex;gap:8px;padding:12px;border-top:1px solid rgba(0,0,0,0.04);background:var(--panel)}
  .composer textarea{flex:1;min-height:54px;resize:none;padding:10px;border-radius:10px;border:1px solid #e6eef7;outline:none}
  .sendRow{display:flex;flex-direction:column;gap:8px}
  .sendBtn{background:var(--accent);color:#fff;border:none;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
  .quickReplies{display:flex;gap:8px;flex-wrap:wrap}
  .qr{background:#f0f5ff;border-radius:8px;padding:6px 10px;font-size:13px;border:1px solid rgba(0,0,0,0.04);cursor:pointer}

/* small helpers */
  .toolbar{display:flex;gap:8px;align-items:center}
  .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;transition:all .3s;z-index:50}
  .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* responsive */
  @media (max-width:900px){
    aside{width:100%;height:auto;border-right:none;border-bottom:1px solid rgba(0,0,0,0.04);display:block}
    .app{flex-direction:column}
    .chatWrap{height:calc(100vh - 340px);min-height:420px}
  }
</style>
</head>
<body data-theme="">

<!-- Top bar -->
<div class="topbar">
  <div class="brand">
    <div class="logo">AG</div>
    <div>
      <h1 style="margin:0">Admin Chat â€” Agent</h1>
      <div style="font-size:12px;color:var(--muted)">Live support dashboard</div>
    </div>
  </div>

  <div class="controls">
    <div style="display:flex;gap:8px;align-items:center">
      <button id="darkToggle" class="smallBtn" title="Toggle dark mode"><i class='bx bx-moon'></i></button>
      <button id="exportAllBtn" class="smallBtn" title="Export current chat">Export Chat</button>
    </div>
  </div>
</div>

<!-- App -->
<div class="app">
  <aside>
    <div class="search">
      <input id="searchInput" placeholder="Search users by name or email" />
      <button id="refreshBtn" class="smallBtn" title="Refresh users"><i class='bx bx-refresh'></i></button>
    </div>

    <div class="stats" style="margin-top:6px">
      <div class="stat" id="totalChats">Chats: 0</div>
      <div class="stat" id="totalMessages">Messages: 0</div>
      <div class="stat" id="activeUsers">Active: 0</div>
    </div>

    <div id="userList" aria-live="polite"></div>
  </aside>

  <section class="chatWrap" role="main">
    <div class="chatHeader">
      <div class="title">
        <div id="chatAvatar" class="avatar" style="background:#e6eef7;color:#083b66">â€”</div>
        <div>
          <div id="chatName" style="font-weight:700">Select a user</div>
          <div id="chatEmail" style="font-size:12px;color:var(--muted)">â€”</div>
        </div>
      </div>

      <div class="metaRight">
        <div id="chatCounts" style="font-size:13px;color:var(--muted)">â€”</div>
        <button id="deleteChatBtn" class="smallBtn" title="Delete chat"><i class='bx bx-trash'></i></button>
        <button id="exportBtn" class="smallBtn" title="Export">Export</button>
      </div>
    </div>

    <div class="messages" id="messages"></div>

    <div class="composer">
      <div style="flex:1;display:flex;flex-direction:column;gap:8px">
        <div class="quickReplies" id="quickReplies">
          <div class="qr">Hello ðŸ‘‹</div>
          <div class="qr">Thanks for reaching out â€” we will reply shortly.</div>
          <div class="qr">Please share your order number.</div>
        </div>
        <textarea id="replyInput" placeholder="Type your reply..."></textarea>
      </div>

      <div class="sendRow">
        <button id="sendBtn" class="sendBtn">Send</button>
        <button id="notifyTest" class="smallBtn" title="Test notification">Test</button>
      </div>
    </div>
  </section>
</div>

<div id="toast" class="toast"></div>
<audio id="notifySound" src="https://assets.mixkit.co/active_storage/sfx/2212/2212-preview.mp3" preload="auto"></audio>

<script>
/* ================= CONFIG ================= */
const firebaseConfig = {
  apiKey: "AIzaSyB4DMYZJHWgbRUZV-uamOy7TpxLM1sGYPY",
  authDomain: "chats-afcff.firebaseapp.com",
  databaseURL: "https://chats-afcff-default-rtdb.firebaseio.com",
  projectId: "chats-afcff",
  storageBucket: "chats-afcff.appspot.com",
  messagingSenderId: "764250889947",
  appId: "1:764250889947:web:2c843497ce389edf5876fe"
};

const EMAILJS_SERVICE = "service_7servqq";
const EMAILJS_TEMPLATE = "template_abw3a7q";
const EMAILJS_PUBLIC_KEY = "ayBtD4ucWPOYC7x47";

const ADMIN_NAME = "Agent Chen K";
const ADMIN_EMAIL = "smith4jones778@gmail.com";
/* ========================================== */

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
emailjs.init(EMAILJS_PUBLIC_KEY);

/* ====== App state ====== */
let usersCache = {};           // { chatId: { username, email, lastMessageTimestamp, unread } }
let currentChatId = null;
let lastLoadedTimestampForChat = {}; // remember when listener attached per chat to avoid duplicate email sends
let msgListenerRefs = {};      // to detach listeners cleanly

/* ====== Elements ====== */
const userListEl = document.getElementById('userList');
const messagesEl = document.getElementById('messages');
const chatNameEl = document.getElementById('chatName');
const chatEmailEl = document.getElementById('chatEmail');
const chatAvatarEl = document.getElementById('chatAvatar');
const chatCountsEl = document.getElementById('chatCounts');
const replyInput = document.getElementById('replyInput');
const sendBtn = document.getElementById('sendBtn');
const toastEl = document.getElementById('toast');
const notifySound = document.getElementById('notifySound');
const searchInput = document.getElementById('searchInput');
const totalChatsEl = document.getElementById('totalChats');
const totalMessagesEl = document.getElementById('totalMessages');
const activeUsersEl = document.getElementById('activeUsers');
const darkToggle = document.getElementById('darkToggle');
const exportBtn = document.getElementById('exportBtn');
const exportAllBtn = document.getElementById('exportAllBtn');
const deleteChatBtn = document.getElementById('deleteChatBtn');
const quickRepliesEl = document.getElementById('quickReplies');
const notifyTest = document.getElementById('notifyTest');
const refreshBtn = document.getElementById('refreshBtn');

/* ====== Utilities ====== */
function showToast(msg, time=2200){
  toastEl.textContent = msg;
  toastEl.classList.add('show');
  setTimeout(()=> toastEl.classList.remove('show'), time);
}
function escapeHtml(s){ if (s==null) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;').replaceAll('\n','\n'); }
function avatarText(name){ if(!name) return 'â€”'; return name.split(' ').map(p=>p[0]).slice(0,2).join('').toUpperCase(); }

/* ====== Dark mode ====== */
(function initTheme(){
  const saved = localStorage.getItem('admin_theme') || 'light';
  setTheme(saved);
})();
function setTheme(t){
  document.body.setAttribute('data-theme', t === 'dark' ? 'dark' : '');
  localStorage.setItem('admin_theme', t);
}
darkToggle.addEventListener('click', ()=>{
  const cur = localStorage.getItem('admin_theme') || 'light';
  setTheme(cur==='dark' ? 'light' : 'dark');
});

/* ====== Desktop notifications permission ====== */
if (("Notification" in window) && Notification.permission !== "granted") {
  Notification.requestPermission().catch(()=>{});
}

/* ====== Load users & analytics ====== */
function refreshUsers(){
  db.ref('chats').once('value').then(snap=>{
    usersCache = {};
    let totalMessages = 0;
    snap.forEach(child=>{
      const id = child.key;
      const data = child.val() || {};
      usersCache[id] = {
        username: data.username || id,
        email: data.email || '',
        lastMessageTimestamp: data.lastMessageTimestamp || 0
      };
    });
    // compute unread counts - count messages with seen !== true
    const chatIds = Object.keys(usersCache);
    let active = 0;
    if (chatIds.length===0) renderUserList([]);
    else {
      const promises = chatIds.map(id => db.ref(`chats/${id}/messages`).once('value').then(ms=>{
        let unread = 0, count = 0;
        ms.forEach(m=> {
          const v = m.val();
          count++;
          if (!v.seen && v.sender !== ADMIN_NAME) unread++;
        });
        usersCache[id].unread = unread;
        usersCache[id].messageCount = count;
        totalMessages += count;
        if (count>0) active++;
      }));
      Promise.all(promises).then(()=> {
        updateAnalytics(Object.keys(usersCache).length, totalMessages, active);
        renderUserList(Object.entries(usersCache).map(([id,u])=> ({ id, ...u })));
      });
    }
  });
}
function updateAnalytics(totalChats,totalMessages,activeUsers){
  totalChatsEl.textContent = `Chats: ${totalChats}`;
  totalMessagesEl.textContent = `Messages: ${totalMessages}`;
  activeUsersEl.textContent = `Active: ${activeUsers}`;
}

/* ====== Render user list ====== */
function renderUserList(list){
  const q = (searchInput.value || '').toLowerCase().trim();
  userListEl.innerHTML = '';
  list.filter(u => {
    if (!q) return true;
    return (u.username||'').toLowerCase().includes(q) || (u.email||'').toLowerCase().includes(q);
  }).sort((a,b)=> (b.lastMessageTimestamp||0) - (a.lastMessageTimestamp||0)).forEach(u=>{
    const el = document.createElement('div');
    el.className = 'userItem';
    el.innerHTML = `
      <div style="display:flex;align-items:center;gap:10px">
        <div class="avatar" style="background:#e6eef7;color:#083b66">${escapeHtml(avatarText(u.username))}</div>
        <div>
          <div class="uname">${escapeHtml(u.username)}</div>
          <div class="uMeta">${escapeHtml(u.email)}</div>
        </div>
      </div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
        ${u.unread && u.unread>0 ? `<div class="unread">${u.unread}</div>` : `<div style="font-size:12px;color:var(--muted)">${u.messageCount||0}</div>`}
        <div style="display:flex;gap:6px">
          <button class="smallBtn" title="Open chat">Open</button>
          <button class="smallBtn" title="Delete chat" style="background:transparent;border:1px solid rgba(0,0,0,0.06)">Del</button>
        </div>
      </div>
    `;
    // handlers
    el.querySelectorAll('.smallBtn')[0].addEventListener('click', ()=> openChat(u.id, u.username, u.email));
    el.querySelectorAll('.smallBtn')[1].addEventListener('click', (e)=>{
      e.stopPropagation();
      if (confirm(`Delete chat with ${u.username}? This will remove all messages.`)) {
        db.ref(`chats/${u.id}`).remove().then(()=> { showToast('Chat deleted'); refreshUsers(); });
      }
    });
    el.addEventListener('click', ()=> openChat(u.id, u.username, u.email));
    userListEl.appendChild(el);
  });
}

/* ====== Listen for new chats realtime (for notifications) ====== */
db.ref('chats').on('child_added', ()=> refreshUsers());
db.ref('chats').on('child_removed', ()=> refreshUsers());
db.ref('chats').on('child_changed', ()=> refreshUsers());
refreshBtn.addEventListener('click', refreshUsers);
searchInput.addEventListener('input', ()=> renderUserList(Object.entries(usersCache).map(([id,u])=> ({ id, ...u }))));

/* ====== Open chat & attach listener (with duplicate-email protection) ====== */
function openChat(chatId, userName, userEmail){
  // detach previous listener
  if (currentChatId && msgListenerRefs[currentChatId]) {
    db.ref(`chats/${currentChatId}/messages`).off('child_added', msgListenerRefs[currentChatId]);
    delete msgListenerRefs[currentChatId];
  }

  currentChatId = chatId;
  chatNameEl.textContent = userName || chatId;
  chatEmailEl.textContent = userEmail || '';
  chatAvatarEl.textContent = avatarText(userName);
  replyInput.value = '';

  messagesEl.innerHTML = '<div style="opacity:0.6;font-size:13px;color:var(--muted)">Loading messagesâ€¦</div>';
  // set last loaded timestamp to now to avoid sending email for old messages on attach
  lastLoadedTimestampForChat[chatId] = Date.now();

  // attach listener
  const onChildAdded = snap => {
    const key = snap.key;
    const m = snap.val();
    // render
    appendMessageToUI(m, key);
    // if message is from user (not admin) and is new (timestamp > lastLoadedTimestamp) -> notify admin via email & desktop notification
    const msgTime = new Date(m.timestamp).getTime();
    if (m.sender !== ADMIN_NAME) {
      // mark seen (so unread counters reduce)
      if (!m.seen) {
        db.ref(`chats/${chatId}/messages/${key}`).update({ seen: true }).catch(()=>{});
      }
      // only send email/desktop notify if message is new (after we attached)
      if (msgTime > (lastLoadedTimestampForChat[chatId] || 0)) {
        // Email notify admin
        sendEmailToAdmin(m.sender, (usersCache[chatId] && usersCache[chatId].email) || userEmail, m.text);
        // desktop notify & sound
        showDesktopNotification(`${m.sender}`, m.text);
        notifySound.currentTime = 0; notifySound.play().catch(()=>{});
        showToast('New message received');
        // update users cache unread
        refreshUsers();
      }
    }
    // update counts
    updateChatCounts(chatId);
    // scroll
    messagesEl.scrollTop = messagesEl.scrollHeight;
  };

  msgListenerRefs[chatId] = onChildAdded;
  db.ref(`chats/${chatId}/messages`).on('child_added', onChildAdded);

  // Load existing messages once to populate UI and analytics
  db.ref(`chats/${chatId}/messages`).once('value').then(snap=>{
    messagesEl.innerHTML = '';
    snap.forEach(child=>{
      appendMessageToUI(child.val(), child.key);
      // If any message is unseen and not from admin, mark as seen because admin opened chat
      const v = child.val();
      if (v && !v.seen && v.sender !== ADMIN_NAME) {
        db.ref(`chats/${chatId}/messages/${child.key}`).update({ seen: true }).catch(()=>{});
      }
    });
    messagesEl.scrollTop = messagesEl.scrollHeight;
    updateChatCounts(chatId);
    refreshUsers();
  });
}

/* ====== Append a message to UI ====== */
function appendMessageToUI(m, key){
  const wrapper = document.createElement('div');
  const isSelf = (m.sender === ADMIN_NAME);
  wrapper.innerHTML = `
    <div class="bubble ${isSelf ? 'self' : 'other'}">
      <div style="font-weight:600">${escapeHtml(m.sender)}</div>
      <div style="margin-top:6px;white-space:pre-wrap">${escapeHtml(m.text)}</div>
      <div class="bmeta">${new Date(m.timestamp).toLocaleString()} ${m.seen ? ' â€¢ Seen' : ''}</div>
    </div>
  `;
  messagesEl.appendChild(wrapper);
}

/* ====== Update chat counts (local UI) ====== */
function updateChatCounts(chatId){
  db.ref(`chats/${chatId}/messages`).once('value').then(snap=>{
    const count = snap.numChildren();
    const unseen = Object.values(snap.val()||{}).filter(m => !m.seen && m.sender !== ADMIN_NAME).length;
    chatCountsEl.textContent = `Messages: ${count} â€¢ Unread: ${unseen}`;
  });
}

/* ====== Send message (admin replies) ====== */
sendBtn.addEventListener('click', () => {
  const text = replyInput.value.trim();
  if (!text) return showToast('Type a reply first');
  if (!currentChatId) return alert('Select a user first');

  const msg = { sender: ADMIN_NAME, text, timestamp: new Date().toISOString(), seen: true };
  db.ref(`chats/${currentChatId}/messages`).push(msg).then(()=> {
    replyInput.value = '';
    // update chat meta timestamp
    db.ref(`chats/${currentChatId}`).update({ lastMessageTimestamp: Date.now() }).catch(()=>{});
    // notify user via EmailJS
    const to = (usersCache[currentChatId] && usersCache[currentChatId].email) || chatEmailEl.textContent;
    sendEmailToUser(to, `Reply from ${ADMIN_NAME}`, ADMIN_NAME, text);
    showToast('Reply sent');
    // refresh analytics
    refreshUsers();
    updateChatCounts(currentChatId);
  }).catch(err=> {
    console.error(err); showToast('Failed to send reply');
  });
});

/* ====== Quick replies ====== */
quickRepliesEl.addEventListener('click', e=>{
  if (e.target.classList.contains('qr')) {
    replyInput.value += (replyInput.value ? '\n' : '') + e.target.textContent;
    replyInput.focus();
  }
});

/* ====== Export chat to .txt ====== */
function exportChat(chatId, filename){
  if (!chatId) return showToast('Select a chat first');
  db.ref(`chats/${chatId}/messages`).once('value').then(snap=>{
    let lines = [];
    snap.forEach(child => {
      const m = child.val();
      lines.push(`[${new Date(m.timestamp).toLocaleString()}] ${m.sender}: ${m.text}`);
    });
    const blob = new Blob([lines.join('\n\n')], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename || `chat-${chatId}.txt`;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  });
}
exportBtn.addEventListener('click', ()=> exportChat(currentChatId, `${(chatNameEl.textContent||'chat').replace(/\s+/g,'_')}.txt`));
exportAllBtn.addEventListener('click', ()=> exportChat(currentChatId, `${(chatNameEl.textContent||'chat').replace(/\s+/g,'_')}_export.txt`));

/* ====== Delete chat button ====== */
deleteChatBtn.addEventListener('click', ()=>{
  if (!currentChatId) return showToast('Select a chat first');
  if (confirm(`Delete entire chat with ${chatNameEl.textContent}?`)) {
    db.ref(`chats/${currentChatId}`).remove().then(()=> {
      showToast('Chat removed'); currentChatId = null;
      messagesEl.innerHTML = ''; chatNameEl.textContent = 'Select a user'; chatEmailEl.textContent = '';
      refreshUsers();
    });
  }
});

/* ====== Notifications ====== */
function showDesktopNotification(title, message){
  if (!("Notification" in window)) return;
  if (Notification.permission === "granted") {
    const n = new Notification(title, { body: message.substring(0,120), icon: undefined });
    setTimeout(()=> n.close(), 6000);
  }
}

/* ====== EmailJS functions (send but avoid duplicates on reload by relying on lastLoadedTimestampForChat) ====== */
function sendEmailToAdmin(fromName, fromEmail, text){
  const params = {
    to_email: ADMIN_EMAIL,
    from_name: fromName,
    from_email: fromEmail || '',
    subject: `New message from ${fromName}`,
    message: `New message from ${fromName} (${fromEmail}):\n\n${text}`
  };
  emailjs.send(EMAILJS_SERVICE, EMAILJS_TEMPLATE, params)
    .then(()=> console.log('Admin notified via EmailJS'))
    .catch(err=> console.error('EmailJS admin error',err));
}
function sendEmailToUser(to, subject, fromName, messageText){
  const params = {
    to_email: to,
    from_name: fromName || ADMIN_NAME,
    from_email: ADMIN_EMAIL,
    subject,
    message: messageText
  };
  emailjs.send(EMAILJS_SERVICE, EMAILJS_TEMPLATE, params)
    .then(()=> console.log('User notified via EmailJS'))
    .catch(err=> console.error('EmailJS user error',err));
}

/* ====== Test notification button ====== */
notifyTest.addEventListener('click', ()=>{
  showDesktopNotification('Test notification','This is a test.');
  notifySound.currentTime = 0; notifySound.play().catch(()=>{});
  showToast('Notification test sent');
});

/* ====== Initialize EmailJS & refresh users ====== */
emailjs.init(EMAILJS_PUBLIC_KEY);
refreshUsers();

/* ====== Periodic analytics update (optional) ====== */
setInterval(()=>refreshUsers(), 60_000); // refresh every 60s
</script>
</body>
</html>
